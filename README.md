# Система автоматического формирования модели кредитного скоринга

Комплексная система автоматического построения ML-пайплайнов для кредитного скоринга с **полной сериализацией**, **CLI интерфейсом** и **производственным развертыванием**. Использует **генетический алгоритм** для поиска оптимальных конфигураций всего пайплайна от предобработки до обучения модели.

## 🎯 Ключевые особенности

### 🔄 **Полная сериализация пайплайна**
- **Сохранение всех состояний** препроцессоров (импутация, кодировка, масштабирование)
- **ProductionPipeline** для воспроизводимых предсказаний
- **Автоматическая предобработка** при inference
- **Версионность** моделей с метаданными

### 🖥️ **Профессиональный CLI интерфейс**
- **4 команды**: run-chromosome, run-ga, predict, list-models
- **Автоматическое сохранение** лучших моделей
- **Пакетные предсказания** с форматированными результатами
- **Управление моделями** с детальной информацией

### 🧬 **Генетическая оптимизация**
- **20-генная хромосома** кодирует весь пайплайн
- **Автоматический поиск** оптимальных конфигураций
- **Множественные алгоритмы**: от логистической регрессии до нейронных сетей
- **Целевая метрика**: AUPRC (оптимальна для несбалансированных данных)

### 🏭 **Производственная готовность**
- **Один файл - полный пайплайн**: модель + предобработка + метаданные
- **Автоматическая обработка** новых данных (включая отсутствующие признаки)
- **Отсутствие data leakage** при предсказаниях
- **Кредитный скоринг** с автоматической оценкой рисков

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    CLI ИНТЕРФЕЙС                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │run-chromosome│ │   run-ga    │ │   predict   │→ Production│
│  │   (ручной)  │ │(автоматич.) │ │(применение) │  Pipeline  │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                           │
                   ┌───────▼────────┐
                   │ ГЕНЕТИЧЕСКИЙ АЛГОРИТМ │
                   │   (20-генная хромосома) │
                   └────────┬───────┘
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ПРЕДОБРАБОТКА│ │МОДИФИКАЦИЯ  │ │ ОБУЧЕНИЕ    │
    │• Импутация  │ │• Балансировка│ │• Модели ML  │
    │• Кодирование│ │• Масштабиров.│ │• Валидация  │
    │• Выбросы    │ │             │ │• Метрики    │
    └─────────────┘ └─────────────┘ └─────────────┘
                           │
                   ┌───────▼────────┐
                   │ PRODUCTION PIPELINE │
                   │ Полная сериализация │
                   │ + Метаданные       │
                   └────────────────────┘
```

## 📁 Структура проекта

```
project/
│
├── src/
│   ├── cli.py                     # 🖥️ CLI интерфейс (4 команды)
│   ├── main.py                    # Центральный модуль
│   ├── ga_optimizer.py            # 🧬 Генетический алгоритм
│   ├── pipeline_processor.py      # 🔄 Обработчик ML-пайплайна
│   │
│   ├── preprocessing/              # Модули предобработки
│   │   ├── data_loader.py         # Загрузка данных
│   │   ├── data_preprocessor.py   # Импутация и кодирование
│   │   ├── outlier_remover.py     # Удаление выбросов
│   │   └── resampler.py           # Балансировка классов
│   │
│   ├── modeling/
│   │   └── model_trainer.py       # Обучение и оценка моделей
│   │
│   ├── deployment/                 # 🏭 Производственное развертывание
│   │   ├── production_pipeline.py # ProductionPipeline класс
│   │   └── model_serializer.py    # Универсальная сериализация
│   │
│   └── utils/
│       ├── data_analysis.py       # Анализ данных
│       └── results_saver.py       # Сохранение результатов
│
├── models/                        # 💾 Сохраненные модели и пайплайны
├── datasets/                      # 📊 Исходные датасеты
├── results/                       # 🎯 Результаты предсказаний
├── research/                      # 🔬 Результаты экспериментов ГА
├── CLI_Documentation.md           # 📖 Подробная документация CLI
├── requirements.txt
└── README.md
```

## 🖥️ CLI Интерфейс

### Команды CLI

```bash
# 1. Запуск конкретной хромосомы с полной сериализацией
python src/cli.py run-chromosome \
  --chromosome "1,2,0,1,1,2,0,1,0,0,1,1,1,0,0,0,2,3,1,0" \
  --dataset "datasets/UCI_Credit_Card.csv" \
  --target "default.payment.next.month"

# 2. Генетический алгоритм с автосохранением лучшей модели  
python src/cli.py run-ga \
  --dataset "datasets/diabetes.csv" \
  --target "Outcome" \
  --population 15 \
  --generations 10 \
  --auto-save

# 3. Применение модели с автоматической предобработкой
python src/cli.py predict \
  --model "UCI_Credit_Card_GA_best_20250108_150000" \
  --data "new_applications.csv" \
  --output "results/predictions.csv"

# 4. Просмотр доступных моделей
python src/cli.py list-models --verbose
```

### 💾 Структура сохраненных моделей

```
models/
├── UCI_Credit_Card_logistic_regression_20250108_143022/  # Полный пайплайн
│   ├── sklearn_model.joblib                 # Обученная модель
│   ├── keras_model/                         # TensorFlow модель (если NN)
│   ├── preprocessor_states.pkl              # Состояния всех препроцессоров
│   ├── model_info.json                      # Техническая информация
│   └── pipeline_metadata.json               # Метаданные пайплайна
└── UCI_Credit_Card_logistic_regression_20250108_143022_metadata.json  # CLI метаданные
```

## 🧬 Генетический алгоритм

### Структура хромосомы (20 генов)
```
Гены 0-2:   Импутация      (KNN, медиана, MissForest + параметры)
Гены 3-5:   Выбросы        (нет, Isolation Forest, IQR + параметры)  
Гены 6-8:   Ресемплинг     (нет, SMOTE, ADASYN, ROS + параметры)
Гены 9-11:  Кодирование    (OneHot, Label, LSA, Word2Vec + параметры)
Гены 12-14: Масштабирование (нет, Standard, MinMax + параметры)
Гены 15-19: Модель         (LogReg, RF, GB, NN + 4 гиперпараметра)
```

### Новые возможности ГА
- **Автоматическое сохранение** лучшей модели с флагом `--auto-save`
- **Конфигурируемые параметры** через CLI
- **Подробное логирование** прогресса эволюции
- **Метаданные ГА** сохраняются вместе с моделью

## 🏭 Production Pipeline

### Автоматическая предобработка
```python
# При предсказании ProductionPipeline автоматически:
# 1. Удаляет целевую колонку (если присутствует)
# 2. Удаляет ID колонки (которые были удалены при обучении)
# 3. Применяет импутацию с сохраненными параметрами  
# 4. Применяет кодирование с сохраненными состояниями
# 5. Применяет масштабирование с сохраненным скейлером
# 6. Выполняет предсказания
# 7. Форматирует результаты с кредитным скорингом
```

### Обработка отсутствующих признаков
- **Автоматическое добавление** недостающих колонок (заполнение нулями)
- **Предупреждения** о несовпадениях схемы данных
- **Гибкая обработка** дополнительных колонок

### Кредитный скоринг
```csv
# Результаты содержат:
ID, LIMIT_BAL, SEX, ..., prediction, probability_class_0, probability_class_1, credit_score, risk_level
1,  50000,     1,   ..., 0,          0.723,             0.277,               0.277,        High
2,  80000,     2,   ..., 1,          0.440,             0.560,               0.560,        Medium
```

## 🛠️ Поддерживаемые методы

### Импутация пропущенных значений
- **KNN Imputer** (n_neighbors: 3-15)
- **Median/Mode** импутация
- **MissForest** импутация (n_estimators: 30-200, max_iter: 5-20)

### Кодирование категориальных признаков
- **One-Hot Encoding** (max_cardinality: 10-100, drop: None/first)
- **Label Encoding** 
- **LSA (Latent Semantic Analysis)** (n_components: 5-75, ngram_max: 1-3)
- **Word2Vec** эмбеддинги (dimensions: 25-150, window: 1-7)

### Удаление выбросов
- **Без обработки**
- **Isolation Forest** (n_estimators: 30-200, contamination: auto-0.15)
- **IQR Method** (multiplier: 1.5-3.0)

### Балансировка классов
- **Без балансировки**
- **Random OverSampling** (sampling_strategy: auto-0.75)
- **SMOTE** (k_neighbors: 3-9, sampling_strategy: auto-0.75)
- **ADASYN** (n_neighbors: 3-9, sampling_strategy: auto-0.75)

### Масштабирование
- **Без масштабирования**
- **StandardScaler** (with_mean: True/False, with_std: True/False)
- **MinMaxScaler**

### Модели машинного обучения
- **Logistic Regression** (C: 0.001-100, penalty+solver, class_weight, max_iter)
- **Random Forest** (n_estimators: 25-300, max_depth: 5-None, min_samples_split/leaf)
- **Gradient Boosting** (n_estimators: 25-300, learning_rate: 0.005-0.2, max_depth, subsample)
- **Neural Networks** (Keras: архитектуры, dropout: 0-0.5, learning_rate, batch_size)

## 🚀 Установка и использование

### 1. Клонирование и настройка
```bash
git clone <repository_url>
cd project
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
pip install -r requirements.txt
```

### 2. Подготовка данных
```bash
# Поместите CSV файлы в папку datasets/
# Поддерживаются:
# - Бинарная и мультиклассовая классификация
# - Смешанные типы данных (числовые + категориальные)
# - Файлы с ID колонками (автоматически обрабатываются)
# - Файлы с пропущенными значениями
```

### 3. Быстрый старт

#### Автоматическая оптимизация (рекомендуется)
```bash
# Запуск ГА с автосохранением лучшей модели
python src/cli.py run-ga \
  --dataset "datasets/UCI_Credit_Card.csv" \
  --target "default.payment.next.month" \
  --population 15 \
  --generations 10 \
  --auto-save
```

#### Ручная настройка
```bash
# Тестирование конкретной конфигурации
python src/cli.py run-chromosome \
  --chromosome "2,1,2,1,2,1,2,1,2,1,0,1,1,0,1,1,2,3,1,2" \
  --dataset "datasets/diabetes.csv" \
  --target "Outcome"
```

#### Применение в производстве
```bash
# Просмотр доступных моделей
python src/cli.py list-models

# Применение к новым данным
python src/cli.py predict \
  --model "diabetes_GA_best_20250108_150000" \
  --data "new_patients.csv" \
  --output "results/risk_assessment.csv"
```

## 📊 Результаты и мониторинг

### Автоматические отчеты
```
results/
├── predictions_TIMESTAMP.csv           # Результаты предсказаний
├── credit_scoring_results.csv          # Кредитный скоринг
└── model_performance_report.json       # Отчет о производительности

research/
└── [dataset_name]/
    └── genetic_algorithm_runs/
        ├── generation_X_results/        # Результаты каждого поколения
        ├── fitness_progression.png      # График эволюции
        └── best_model_analysis/         # Анализ лучшей модели
```

### Метрики качества
- **AUPRC** (основная целевая метрика для несбалансированных данных)
- **ROC AUC**
- **F1-Score** (binary, macro, micro, weighted)
- **Accuracy, Precision, Recall**
- **Classification Report** с детализацией по классам

### Кредитный скоринг
- **Credit Score**: вероятность дефолта (0-1)
- **Risk Level**: High (>0.7), Medium (0.4-0.7), Low (<0.4)
- **Автоматическая категоризация** рисков

## 🔧 Конфигурация

### Настройка ГА через CLI
```bash
python src/cli.py run-ga \
  --dataset "data.csv" \
  --target "target" \
  --population 20 \        # Размер популяции
  --generations 15 \       # Количество поколений
  --elitism 0.3 \         # Процент элитизма (0.0-1.0)
  --mutation 0.15 \       # Вероятность мутации (0.0-1.0)
  --tournament 5 \        # Размер турнира
  --learning-curves \     # Генерировать кривые обучения
  --auto-save             # Автосохранение лучшей модели
```

### Расширение системы
```python
# Добавление нового метода предобработки
# 1. В соответствующий preprocessor добавить метод
# 2. Добавить в MAPPING в `ChromosomeConfig`
# 3. Определить гиперпараметры
# 4. Обновить диапазоны генов
```

## 🎯 Примеры использования

### Полный жизненный цикл модели
```bash
# 1. Автоматическая оптимизация
python src/cli.py run-ga \
  --dataset "datasets/loan_data.csv" \
  --target "default" \
  --population 20 \
  --generations 12 \
  --auto-save

# 2. Просмотр результатов
python src/cli.py list-models --verbose

# 3. Применение в продакшне
python src/cli.py predict \
  --model "loan_data_GA_best_20250108_143022" \
  --data "new_loan_applications.csv" \
  --output "results/loan_risk_assessment.csv"
```

### Сравнение конфигураций
```bash
# Тестирование разных хромосом
python src/cli.py run-chromosome \
  --chromosome "1,0,1,0,2,1,0,0,1,0,0,1,0,1,0,0,1,2,0,1" \
  --dataset "datasets/credit.csv" \
  --target "default"

python src/cli.py run-chromosome \
  --chromosome "2,1,2,1,2,1,1,1,2,1,1,1,1,1,1,1,2,3,2,3" \
  --dataset "datasets/credit.csv" \
  --target "default"
```

## 📈 Производительность

### Автоматизация
- **20 параметров** пайплайна оптимизируются автоматически
- **4 типа моделей** с индивидуальной настройкой гиперпараметров
- **Продвинутые методы** кодирования (LSA, Word2Vec)
- **Целевая метрика AUPRC** для несбалансированных данных

### Производственная готовность
- **Полная сериализация** состояний препроцессоров
- **Воспроизводимость** предобработки при inference
- **Автоматическая обработка** отсутствующих признаков
- **Отсутствие data leakage** благодаря изолированной предобработке

### Масштабируемость
- **Пакетная обработка** через CLI
- **Версионирование моделей** с метаданными
- **Легкое расширение** новыми методами и моделями
- **Интеграция** в существующие ML-пайплайны

## 🔍 Мониторинг и отладка

### Подробное логирование
```
🚀 Запуск оптимизации...
🧬 Поколение 1/10: Лучший фитнес 0.7234
📊 Модель: random_forest, Хромосома: [1,2,0,1,1,2,0,1,0,0,1,1,1,0,0,1,2,3,1,0]
💾 Сохранение лучшей модели...
✅ Полный пайплайн успешно сохранен!
```

### Диагностика предсказаний
```
🔍 Анализ структуры данных...
📊 Ожидаемые признаки (23): ['LIMIT_BAL', 'SEX', 'EDUCATION', ...]
📊 Полученные колонки (24): ['ID', 'LIMIT_BAL', 'SEX', ...]
⚠️ Отсутствующие признаки: ['MARRIAGE']
🔄 Применение полного пайплайна с предобработкой...
⚙️ Импутация применена
⚙️ Кодирование применено  
⚙️ Масштабирование применено
```

## 📋 Требования

### Основные зависимости
- **Python 3.7+**
- **NumPy, Pandas, Scikit-learn** (основные библиотеки ML)
- **TensorFlow** (для нейронных сетей)
- **Gensim** (для Word2Vec эмбеддингов)
- **Imbalanced-learn** (для балансировки классов)
- **Matplotlib, Seaborn** (для визуализации)

### Дополнительные библиотеки
- **MissForest** (для продвинутой импутации)
- **Joblib** (для сериализации моделей)
- **Pathlib** (для работы с путями)

Полный список зависимостей см. в `requirements.txt`.

## 📖 Документация

- **CLI_Documentation.md** - Подробное руководство по CLI интерфейсу
- **README.md** - Этот файл с общим обзором системы
- Inline документация во всех модулях

## 🤝 Расширение системы

Архитектура спроектирована для легкого расширения:

### Добавление новых методов предобработки
1. Реализовать метод в соответствующем preprocessor
2. Добавить в MAPPING в `ChromosomeConfig`
3. Определить гиперпараметры
4. Обновить диапазоны генов

### Добавление новых моделей
1. Добавить в `ModelTrainer._build_model()`
2. Обновить `MODEL_MAP` в конфигурации
3. Определить специфичные гиперпараметры
4. Добавить в универсальный сериализатор

### Новые метрики оптимизации
1. Реализовать в `ModelTrainer.train()`
2. Обновить функцию фитнеса в `ga_optimizer.py`
3. Добавить в CLI отчеты

---

**🧬 Автоматизация ML-пайплайнов для кредитного скоринга с полной производственной готовностью** 🎯💾